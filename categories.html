<!DOCTYPE html>
<html lang="vi">

<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QYK5R13WK2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-QYK5R13WK2');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªÉ Lo·∫°i Phim - A Phim</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#f2f20d",
                        "background-dark": "#1a1a0c",
                        "surface-dark": "#2a2a18",
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-background-dark text-white">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b border-white/10">
        <div class="container mx-auto px-6 h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 group">
                <div
                    class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center shadow-lg shadow-primary/30 group-hover:scale-105 transition-transform">
                    <span class="material-icons-round text-black text-2xl">play_arrow</span>
                </div>
                <span class="text-2xl font-bold tracking-tight">
                    <span class="text-white">A</span> <span class="text-primary">Phim</span>
                </span>
            </a>

            <!-- Desktop Menu -->
            <div class="hidden lg:flex items-center gap-6">
                <a class="text-gray-300 hover:text-primary font-medium transition-colors text-sm uppercase tracking-wide"
                    href="index.html">Trang ch·ªß</a>

                <!-- Phim Link -->
                <a href="phim-viet-nam.html"
                    class="text-gray-300 hover:text-primary font-medium transition-colors text-sm uppercase tracking-wide">
                    üáªüá≥ Phim Vi·ªát Nam
                </a>

                <!-- Th·ªÉ Lo·∫°i Dropdown -->
                <div class="relative group">
                    <button
                        class="text-primary font-bold transition-colors text-sm uppercase tracking-wide flex items-center gap-1">
                        Th·ªÉ Lo·∫°i
                        <span class="material-icons-round text-sm">expand_more</span>
                    </button>
                    <div id="categoryDropdown"
                        class="absolute top-full left-0 mt-2 w-64 max-h-96 overflow-y-auto bg-black/95 backdrop-blur-md border border-white/10 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                        <!-- Categories will be loaded here -->
                        <div class="p-4 text-center text-gray-400">ƒêang t·∫£i...</div>
                    </div>
                </div>
                <a class="text-gray-300 hover:text-primary font-medium transition-colors text-sm uppercase tracking-wide"
                    href="search.html">Kh√°m ph√°</a>
                <a class="text-gray-300 hover:text-primary font-medium transition-colors text-sm uppercase tracking-wide"
                    href="pricing.html">G√≥i c∆∞·ªõc</a>
                <a class="text-gray-300 hover:text-primary font-medium transition-colors text-sm uppercase tracking-wide"
                    href="support.html">Nu√¥i APhim</a>
            </div>

            <div class="flex items-center gap-4">
                <a href="search.html" class="text-gray-300 hover:text-primary transition-colors">
                    <span class="material-icons-round">search</span>
                </a>
                <a href="login.html"
                    class="px-6 py-2 bg-primary text-black font-bold rounded-full hover:bg-primary-dim transition-colors">ƒêƒÉng
                    nh·∫≠p</a>
            </div>

            <!-- Mobile Menu Button -->
            <button id="mobileMenuBtn" class="lg:hidden text-white">
                <span class="material-icons-round">menu</span>
            </button>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="lg:hidden hidden bg-black/95 backdrop-blur-md border-t border-white/10">
            <div class="container mx-auto px-6 py-4">
                <a href="index.html" class="block py-3 text-gray-300 hover:text-primary transition-colors">
                    üè† Trang ch·ªß
                </a>
                <a href="phim-viet-nam.html" class="block py-3 text-gray-300 hover:text-primary transition-colors">
                    üáªüá≥ Phim Vi·ªát Nam
                </a>
                <div class="py-3">
                    <div class="text-primary text-sm font-bold mb-2">TH·ªÇ LO·∫†I</div>
                    <div id="mobileCategoryList" class="pl-4">
                        <div class="text-gray-400 text-sm">ƒêang t·∫£i...</div>
                    </div>
                </div>
                <a href="search.html" class="block py-3 text-gray-300 hover:text-primary transition-colors">
                    üîç Kh√°m ph√°
                </a>
                <a href="pricing.html" class="block py-3 text-gray-300 hover:text-primary transition-colors">
                    üíé G√≥i c∆∞·ªõc
                </a>
                <a href="support.html" class="block py-3 text-gray-300 hover:text-primary transition-colors">
                    ‚ù§Ô∏è Nu√¥i APhim
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 pt-32 pb-20">
        <!-- Header -->
        <div class="mb-12">
            <h1 id="pageTitle" class="text-4xl md:text-5xl font-bold mb-4">
                Th·ªÉ Lo·∫°i Phim
            </h1>
            <p id="pageSubtitle" class="text-gray-400 text-lg">Kh√°m ph√° phim theo th·ªÉ lo·∫°i y√™u th√≠ch c·ªßa b·∫°n</p>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-400">ƒêang t·∫£i...</p>
        </div>

        <!-- Categories Grid (Default View) -->
        <div id="categoriesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 hidden">
            <!-- Categories will be loaded here -->
        </div>

        <!-- Movies Grid (Category View) -->
        <div id="moviesSection" class="hidden">
            <!-- Back Button -->
            <div class="mb-6">
                <button onclick="showAllCategories()"
                    class="flex items-center gap-2 text-gray-300 hover:text-primary transition-colors">
                    <span class="material-icons-round">arrow_back</span>
                    <span>Quay l·∫°i danh s√°ch th·ªÉ lo·∫°i</span>
                </button>
            </div>

            <!-- Movies Grid -->
            <div id="moviesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- Movies will be loaded here -->
            </div>

            <!-- Pagination -->
            <div id="pagination" class="mt-12 flex justify-center items-center gap-2">
                <!-- Pagination will be loaded here -->
            </div>
        </div>

        <!-- Error -->
        <div id="error" class="hidden text-center py-20">
            <span class="material-icons-round text-6xl text-red-400 mb-4">error_outline</span>
            <p class="text-red-400 text-lg">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</p>
        </div>
    </main>

    <script src="js/analytics.js"></script>
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/user.js"></script>
    <script src="js/user-ui.js"></script>

    <script>
        let allCategories = [];
        let currentCategory = null;
        let currentPage = 1;
        let totalPages = 1;

        const loading = document.getElementById('loading');
        const categoriesGrid = document.getElementById('categoriesGrid');
        const moviesSection = document.getElementById('moviesSection');
        const moviesGrid = document.getElementById('moviesGrid');
        const pagination = document.getElementById('pagination');
        const error = document.getElementById('error');
        const pageTitle = document.getElementById('pageTitle');
        const pageSubtitle = document.getElementById('pageSubtitle');

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Load categories on page load
        async function loadCategories() {
            try {
                console.log('Fetching categories from API...');

                const response = await fetch('https://ophim1.com/v1/api/the-loai', {
                    method: 'GET',
                    headers: { 'accept': 'application/json' }
                });

                const data = await response.json();
                console.log('Categories data:', data);
                console.log('Categories data.data type:', typeof data.data);
                console.log('Categories data.data:', data.data);
                console.log('Categories data.data keys:', Object.keys(data.data));
                console.log('Categories data.data first entry:', Object.entries(data.data)[0]);

                if (data.status === 'success' && data.data) {
                    // API returns data.data.items as array of categories
                    if (data.data.items && Array.isArray(data.data.items)) {
                        allCategories = data.data.items;
                    } else if (Array.isArray(data.data)) {
                        allCategories = data.data;
                    } else if (typeof data.data === 'object') {
                        // Fallback: Convert object to array
                        allCategories = Object.entries(data.data).map(([key, value]) => {
                            if (typeof value === 'object' && value.slug && value.name) {
                                return value;
                            } else if (typeof value === 'string') {
                                return { slug: key, name: value };
                            }
                            return { slug: key, name: key };
                        });
                    }

                    console.log('Categories array:', allCategories);
                    console.log('Total categories:', allCategories.length);

                    if (allCategories.length === 0) {
                        throw new Error('No categories found');
                    }

                    // Load dropdown
                    loadCategoriesDropdown();

                    // Show categories grid
                    renderCategoriesGrid();
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (err) {
                console.error('Error loading categories:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
            }
        }

        // Load categories dropdown
        function loadCategoriesDropdown() {
            // Desktop dropdown
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown && allCategories.length > 0) {
                dropdown.innerHTML = allCategories.map(cat => `
                    <a href="#" onclick="loadCategoryMovies('${cat.slug}', '${cat.name}'); return false;" 
                       class="block px-4 py-3 text-gray-300 hover:text-primary hover:bg-white/5 transition-colors">
                        ${cat.name}
                    </a>
                `).join('');
            }

            // Mobile list
            const mobileList = document.getElementById('mobileCategoryList');
            if (mobileList && allCategories.length > 0) {
                mobileList.innerHTML = allCategories.map(cat => `
                    <a href="#" onclick="loadCategoryMovies('${cat.slug}', '${cat.name}'); return false;" 
                       class="block py-2 text-gray-300 hover:text-primary transition-colors">
                        ${cat.name}
                    </a>
                `).join('');
            }
        }

        // Render categories grid with movie images
        async function renderCategoriesGrid() {
            loading.classList.add('hidden');
            categoriesGrid.classList.remove('hidden');
            moviesSection.classList.add('hidden');

            // Load sample movies for each category to get poster images
            const categoryPromises = allCategories.map(async (category) => {
                try {
                    const response = await fetch(`https://ophim1.com/v1/api/the-loai/${category.slug}?page=1&limit=1`, {
                        method: 'GET',
                        headers: { 'accept': 'application/json' }
                    });
                    const data = await response.json();

                    if (data.status === 'success' && data.data && data.data.items && data.data.items.length > 0) {
                        const movie = data.data.items[0];
                        const posterUrl = movie.thumb_url ? `https://img.ophim.live/uploads/movies/${movie.thumb_url}` : null;
                        return { ...category, posterUrl };
                    }
                    return { ...category, posterUrl: null };
                } catch (error) {
                    console.error(`Error loading sample movie for ${category.name}:`, error);
                    return { ...category, posterUrl: null };
                }
            });

            const categoriesWithImages = await Promise.all(categoryPromises);

            categoriesGrid.innerHTML = categoriesWithImages.map((category) => {
                const backgroundStyle = category.posterUrl
                    ? `background-image: url('${category.posterUrl}'); background-size: cover; background-position: center;`
                    : 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);';

                return `
                    <a href="#" onclick="loadCategoryMovies('${category.slug}', '${category.name}'); return false;" 
                       class="group relative block rounded-xl overflow-hidden hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-2xl aspect-[3/4]"
                       style="${backgroundStyle}">
                        <!-- Dark overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent group-hover:from-black/90 group-hover:via-black/70 transition-all duration-300"></div>
                        
                        <!-- Content -->
                        <div class="relative z-10 h-full flex flex-col justify-end p-6">
                            <h3 class="text-white font-bold text-xl mb-2 drop-shadow-lg">${category.name}</h3>
                            <p class="text-white/90 text-sm drop-shadow-md flex items-center gap-2">
                                <span class="material-icons-round text-primary text-lg">play_circle</span>
                                Kh√°m ph√° ngay
                            </p>
                        </div>
                        
                        <!-- Hover effect -->
                        <div class="absolute inset-0 bg-primary/0 group-hover:bg-primary/10 transition-colors duration-300"></div>
                    </a>
                `;
            }).join('');

            console.log(`Rendered ${categoriesWithImages.length} categories with images`);
        }

        // Load movies by category
        async function loadCategoryMovies(slug, name, page = 1) {
            currentCategory = slug;
            currentPage = page;

            // Update title
            pageTitle.textContent = name;
            pageSubtitle.textContent = 'ƒêang t·∫£i danh s√°ch phim...';

            // Show loading
            loading.classList.remove('hidden');
            categoriesGrid.classList.add('hidden');
            moviesSection.classList.add('hidden');
            error.classList.add('hidden');

            // Close mobile menu
            if (mobileMenu) {
                mobileMenu.classList.add('hidden');
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            try {
                console.log(`Fetching movies for category: ${slug}, page: ${page}`);

                const response = await fetch(`https://ophim1.com/v1/api/the-loai/${slug}?page=${page}&limit=24`, {
                    method: 'GET',
                    headers: { 'accept': 'application/json' }
                });

                const data = await response.json();
                console.log('Category movies data:', data);

                if (data.status === 'success' && data.data) {
                    const movies = data.data.items || [];

                    // Get pagination from params or data
                    const params = data.data.params || data.params || {};
                    const pagination_data = params.pagination || data.data.pagination || {};

                    // Calculate pagination info
                    const totalItems = pagination_data.totalItems || pagination_data.total || movies.length;
                    const totalPages_api = pagination_data.totalPages || Math.ceil(totalItems / 24) || 1;
                    totalPages = totalPages_api;

                    pageSubtitle.textContent = `Trang ${currentPage}/${totalPages} | T·ªïng ${totalItems.toLocaleString()} k·∫øt qu·∫£`;

                    // Render movies
                    if (movies.length > 0) {
                        renderMovies(movies);
                        renderPagination(pagination_data);
                    } else {
                        throw new Error('No movies found');
                    }
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (err) {
                console.error('Error loading category movies:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
            }
        }

        // Render movies
        function renderMovies(movies) {
            loading.classList.add('hidden');
            categoriesGrid.classList.add('hidden');
            moviesSection.classList.remove('hidden');

            moviesGrid.innerHTML = movies.map(movie => {
                // Fix poster URL with CDN prefix
                const thumbUrl = movie.thumb_url || movie.poster_url || '';
                const posterUrl = thumbUrl ? `https://img.ophim.live/uploads/movies/${thumbUrl}` : 'https://via.placeholder.com/300x450?text=No+Image';
                const year = movie.year || 'N/A';
                const quality = movie.quality || movie.lang || '';
                const episodeCurrent = movie.episode_current || '';

                return `
                    <a href="movie-detail.html?slug=${movie.slug}" 
                       class="group relative block rounded-xl overflow-hidden bg-surface-dark hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-2xl hover:shadow-primary/20">
                        <div class="relative aspect-[2/3] overflow-hidden">
                            <img src="${posterUrl}" 
                                 alt="${movie.name}"
                                 class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                                 onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                            
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                            
                            ${quality ? `
                                <div class="absolute top-2 left-2 px-2 py-1 bg-primary text-black text-xs font-bold rounded">
                                    ${quality}
                                </div>
                            ` : ''}
                            
                            ${episodeCurrent ? `
                                <div class="absolute top-2 right-2 px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">
                                    ${episodeCurrent}
                                </div>
                            ` : ''}
                            
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center shadow-lg">
                                    <span class="material-icons-round text-black text-3xl">play_arrow</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <h3 class="text-white font-bold text-sm mb-1 line-clamp-2 group-hover:text-primary transition-colors">
                                ${movie.name}
                            </h3>
                            <p class="text-gray-400 text-xs line-clamp-1">${movie.origin_name || ''}</p>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-gray-500 text-xs">${year}</span>
                                <div class="flex items-center gap-1 text-primary text-xs">
                                    <span class="material-icons-round text-sm">star</span>
                                    <span>8.5</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');

            console.log(`Rendered ${movies.length} movies`);
        }

        // Render pagination
        function renderPagination(paginationData) {
            if (!paginationData || !paginationData.totalPages || paginationData.totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            const totalPages_api = paginationData.totalPages;
            const currentPage_api = paginationData.currentPage || currentPage;

            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage_api - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages_api, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            let paginationHTML = '';

            // Previous button
            if (currentPage_api > 1) {
                paginationHTML += `
                    <button onclick="goToPage(${currentPage_api - 1})" 
                            class="px-4 py-2 bg-surface-dark text-white rounded-lg hover:bg-primary hover:text-black transition-colors">
                        <span class="material-icons-round text-sm">chevron_left</span>
                    </button>
                `;
            }

            // First page
            if (startPage > 1) {
                paginationHTML += `
                    <button onclick="goToPage(1)" 
                            class="px-4 py-2 bg-surface-dark text-white rounded-lg hover:bg-primary hover:text-black transition-colors">
                        1
                    </button>
                `;
                if (startPage > 2) {
                    paginationHTML += `<span class="text-gray-400">...</span>`;
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage_api) {
                    paginationHTML += `
                        <button class="px-4 py-2 bg-primary text-black font-bold rounded-lg">
                            ${i}
                        </button>
                    `;
                } else {
                    paginationHTML += `
                        <button onclick="goToPage(${i})" 
                                class="px-4 py-2 bg-surface-dark text-white rounded-lg hover:bg-primary hover:text-black transition-colors">
                            ${i}
                        </button>
                    `;
                }
            }

            // Last page
            if (endPage < totalPages_api) {
                if (endPage < totalPages_api - 1) {
                    paginationHTML += `<span class="text-gray-400">...</span>`;
                }
                paginationHTML += `
                    <button onclick="goToPage(${totalPages_api})" 
                            class="px-4 py-2 bg-surface-dark text-white rounded-lg hover:bg-primary hover:text-black transition-colors">
                        ${totalPages_api}
                    </button>
                `;
            }

            // Next button
            if (currentPage_api < totalPages_api) {
                paginationHTML += `
                    <button onclick="goToPage(${currentPage_api + 1})" 
                            class="px-4 py-2 bg-surface-dark text-white rounded-lg hover:bg-primary hover:text-black transition-colors">
                        <span class="material-icons-round text-sm">chevron_right</span>
                    </button>
                `;
            }

            pagination.innerHTML = paginationHTML;
        }

        // Go to page
        function goToPage(page) {
            if (page < 1 || page > totalPages || !currentCategory) return;

            const categoryName = allCategories.find(cat => cat.slug === currentCategory)?.name || currentCategory;
            loadCategoryMovies(currentCategory, categoryName, page);
        }

        // Show all categories
        function showAllCategories() {
            currentCategory = null;
            currentPage = 1;

            pageTitle.textContent = 'Th·ªÉ Lo·∫°i Phim';
            pageSubtitle.textContent = 'Kh√°m ph√° phim theo th·ªÉ lo·∫°i y√™u th√≠ch c·ªßa b·∫°n';

            categoriesGrid.classList.remove('hidden');
            moviesSection.classList.add('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load categories on page load
        loadCategories();
    </script>
</body>

</html>