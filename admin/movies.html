<!DOCTYPE html>
<html class="dark" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Qu·∫£n l√Ω Phim - CineStream Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f2f20d",
                        "background-dark": "#1a1a0c",
                        "surface-dark": "#2a2a18",
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-background-dark text-white">
    <!-- Navigation -->
    <nav class="bg-black/95 border-b border-white/10 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-8">
                <a href="../index.html" class="text-2xl font-bold">
                    Cine<span class="text-primary">Stream</span> Admin
                </a>
                <div class="flex gap-4">
                    <a href="dashboard.html" class="text-gray-400 hover:text-white">Dashboard</a>
                    <a href="movies.html" class="text-primary font-bold">Phim</a>
                    <a href="users.html" class="text-gray-400 hover:text-white">Users</a>
                </div>
            </div>
            <a href="../index.html" class="text-gray-400 hover:text-primary">
                <span class="material-icons-round">logout</span>
            </a>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">Qu·∫£n l√Ω Link Phim</h1>
            <p class="text-gray-400">C·∫≠p nh·∫≠t link video cho c√°c phim t·ª´ API</p>
        </div>

        <!-- Search & Filter -->
        <div class="mb-6 flex gap-4">
            <select id="sourceSelect"
                class="px-4 py-3 bg-surface-dark border border-white/10 rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary">
                <option value="all">T·∫•t c·∫£ phim</option>
                <option value="vietnam">üáªüá≥ Phim Vi·ªát Nam</option>
            </select>
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm phim..."
                class="flex-1 px-4 py-3 bg-surface-dark border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary">
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-400">ƒêang t·∫£i danh s√°ch phim...</p>
        </div>

        <!-- Movies Table -->
        <div id="moviesTable" class="hidden bg-surface-dark rounded-lg border border-white/10 overflow-hidden">
            <table class="w-full">
                <thead class="bg-black/50">
                    <tr class="text-left text-sm text-gray-400">
                        <th class="p-4">Phim</th>
                        <th class="p-4">NƒÉm</th>
                        <th class="p-4">Th·ªÉ lo·∫°i</th>
                        <th class="p-4 w-96">Link Video (m3u8)</th>
                        <th class="p-4 text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="moviesBody" class="divide-y divide-white/5">
                    <!-- Movies will be loaded here -->
                </tbody>
            </table>

            <!-- Pagination -->
            <div id="pagination" class="p-4 border-t border-white/10">
                <!-- Pagination will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        let allMovies = [];
        let movieLinks = JSON.parse(localStorage.getItem('movieLinks') || '{}');
        let currentSource = 'all';
        let currentPage = 1;
        let totalPages = 1;

        // Load movies from API
        async function loadMovies(source = 'all', page = 1) {
            try {
                currentSource = source;
                currentPage = page;
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('moviesTable').classList.add('hidden');

                let url;
                if (source === 'vietnam') {
                    url = `https://ophim1.com/v1/api/quoc-gia/viet-nam?page=${page}`;
                } else {
                    url = `https://ophim1.com/v1/api/danh-sach/phim-moi-cap-nhat?page=${page}`;
                }

                console.log('Loading from:', url);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'accept': 'application/json' }
                });

                const data = await response.json();
                console.log('API Response:', data);

                if (data && data.status === 'success' && data.data && data.data.items) {
                    allMovies = data.data.items;

                    // Get pagination info
                    if (data.data.params && data.data.params.pagination) {
                        totalPages = data.data.params.pagination.totalPages || 1;
                    }

                    renderMovies(allMovies);
                    renderPagination();
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('moviesTable').classList.remove('hidden');
                } else {
                    showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch phim');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('L·ªói khi t·∫£i phim: ' + error.message);
            }
        }

        // Render movies
        function renderMovies(movies) {
            const tbody = document.getElementById('moviesBody');
            tbody.innerHTML = movies.map(movie => {
                const savedLink = movieLinks[movie.slug] || '';
                const categories = movie.category?.map(c => c.name).join(', ') || 'N/A';

                return `
                    <tr class="hover:bg-white/5">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <img src="https://img.ophim.live/uploads/movies/${movie.thumb_url}" 
                                    alt="${movie.name}"
                                    class="w-12 h-16 object-cover rounded"
                                    onerror="this.src='https://via.placeholder.com/100x150'">
                                <div>
                                    <div class="font-bold">${movie.name}</div>
                                    <div class="text-xs text-gray-400">${movie.origin_name || ''}</div>
                                    <div class="text-xs text-gray-500 mt-1">Slug: ${movie.slug}</div>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 text-gray-300">${movie.year || 'N/A'}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 bg-primary/20 text-primary rounded text-xs">
                                ${categories}
                            </span>
                        </td>
                        <td class="p-4">
                            <input type="text" 
                                id="link-${movie.slug}"
                                value="${savedLink}"
                                placeholder="Nh·∫≠p link m3u8..."
                                class="w-full px-3 py-2 bg-black/50 border border-white/10 rounded text-sm text-white placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary">
                        </td>
                        <td class="p-4 text-center">
                            <div class="flex gap-2 justify-center">
                                <button onclick="saveLink('${movie.slug}')" 
                                    class="px-4 py-2 bg-primary text-black font-bold rounded hover:bg-primary/90 transition-colors text-sm">
                                    L∆∞u
                                </button>
                                <button onclick="autoFillLink('${movie.slug}')" 
                                    class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-500 transition-colors text-sm"
                                    title="T·ª± ƒë·ªông l·∫•y link t·ª´ API">
                                    Auto
                                </button>
                                <a href="../watch-simple.html?slug=${movie.slug}" target="_blank"
                                    class="px-4 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-500 transition-colors text-sm">
                                    Xem
                                </a>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Render pagination
        function renderPagination() {
            const container = document.getElementById('pagination');
            if (!container) return;

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="flex items-center justify-center gap-2 mt-6">';

            // Previous button
            if (currentPage > 1) {
                html += `
                    <button onclick="loadMovies('${currentSource}', ${currentPage - 1})" 
                        class="px-4 py-2 bg-surface-dark border border-white/10 rounded hover:bg-white/5 transition-colors">
                        <span class="material-icons-round text-sm">chevron_left</span>
                    </button>
                `;
            }

            // Page numbers
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);

            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <button onclick="loadMovies('${currentSource}', ${i})" 
                        class="px-4 py-2 ${i === currentPage ? 'bg-primary text-black' : 'bg-surface-dark border border-white/10 hover:bg-white/5'} rounded transition-colors">
                        ${i}
                    </button>
                `;
            }

            // Next button
            if (currentPage < totalPages) {
                html += `
                    <button onclick="loadMovies('${currentSource}', ${currentPage + 1})" 
                        class="px-4 py-2 bg-surface-dark border border-white/10 rounded hover:bg-white/5 transition-colors">
                        <span class="material-icons-round text-sm">chevron_right</span>
                    </button>
                `;
            }

            html += `<span class="ml-4 text-gray-400">Trang ${currentPage} / ${totalPages}</span></div>`;
            container.innerHTML = html;
        }

        // Auto fill link from API
        async function autoFillLink(slug) {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '...';

                const response = await fetch(`https://ophim1.com/phim/${slug}`);
                const data = await response.json();

                if (data && data.episodes && data.episodes[0] && data.episodes[0].server_data && data.episodes[0].server_data[0]) {
                    const link = data.episodes[0].server_data[0].link_m3u8 || data.episodes[0].server_data[0].link_embed;

                    if (link) {
                        document.getElementById(`link-${slug}`).value = link;
                        movieLinks[slug] = link;
                        localStorage.setItem('movieLinks', JSON.stringify(movieLinks));
                        alert('‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn link!');
                    } else {
                        alert('‚ùå Kh√¥ng t√¨m th·∫•y link video!');
                    }
                } else {
                    alert('‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu video!');
                }

                btn.disabled = false;
                btn.textContent = 'Auto';
            } catch (error) {
                console.error('Error auto-filling link:', error);
                alert('‚ùå L·ªói khi l·∫•y link: ' + error.message);
                event.target.disabled = false;
                event.target.textContent = 'Auto';
            }
        }

        // Save link
        function saveLink(slug) {
            const input = document.getElementById(`link-${slug}`);
            const link = input.value.trim();

            if (link) {
                movieLinks[slug] = link;
                localStorage.setItem('movieLinks', JSON.stringify(movieLinks));
                alert('‚úÖ ƒê√£ l∆∞u link video cho phim: ' + slug);
            } else {
                delete movieLinks[slug];
                localStorage.setItem('movieLinks', JSON.stringify(movieLinks));
                alert('‚ùå ƒê√£ x√≥a link video!');
            }
        }

        // Source change
        document.getElementById('sourceSelect').addEventListener('change', (e) => {
            loadMovies(e.target.value, 1);
        });

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = allMovies.filter(movie =>
                movie.name.toLowerCase().includes(keyword) ||
                (movie.origin_name && movie.origin_name.toLowerCase().includes(keyword)) ||
                movie.slug.toLowerCase().includes(keyword)
            );
            renderMovies(filtered);
        });

        // Show error
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div class="text-center py-20">
                    <span class="material-icons-round text-6xl text-red-400 mb-4">error</span>
                    <p class="text-red-400">${message}</p>
                    <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-primary text-black font-bold rounded">
                        Th·ª≠ l·∫°i
                    </button>
                </div>
            `;
        }

        // Load on page load
        loadMovies('all', 1);
    </script>
</body>

</html>