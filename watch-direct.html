<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem Phim - CineStream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#f2f20d",
                        "background-dark": "#1a1a0c",
                        "surface-dark": "#2a2a18",
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-background-dark text-white">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 bg-black/95 backdrop-blur-md border-b border-white/10">
        <div class="container mx-auto px-6 h-20 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 group">
                <div
                    class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center shadow-lg shadow-primary/30 group-hover:scale-105 transition-transform">
                    <span class="material-icons-round text-black text-2xl">play_arrow</span>
                </div>
                <span class="text-2xl font-bold tracking-tight text-white">Cine<span
                        class="text-primary">Stream</span></span>
            </a>
            <a href="index.html" class="text-gray-300 hover:text-primary transition-colors">
                <span class="material-icons-round">home</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 pt-32 pb-20">
        <!-- Video Player -->
        <div class="mb-8">
            <div id="playerContainer"
                class="relative w-full aspect-video bg-black rounded-xl overflow-hidden shadow-2xl">
                <div id="loading" class="absolute inset-0 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-400">ƒêang t·∫£i video...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movie Info -->
        <div id="movieInfo" class="bg-surface-dark rounded-xl p-6 border border-white/10">
            <h1 id="movieTitle" class="text-3xl font-bold mb-4">ƒêang t·∫£i...</h1>
            <div id="movieDetails" class="text-gray-400"></div>
        </div>
    </main>

    <script>
        // Get slug from URL
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');

        if (!slug) {
            alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin phim!');
            window.location.href = 'index.html';
        }

        // Get link from localStorage
        const movieLinks = JSON.parse(localStorage.getItem('movieLinks') || '{}');
        const videoUrl = movieLinks[slug];

        if (!videoUrl) {
            document.getElementById('loading').innerHTML = `
                <div class="text-center">
                    <span class="material-icons-round text-6xl text-red-400 mb-4">error_outline</span>
                    <p class="text-red-400 text-lg mb-4">Phim ch∆∞a c√≥ link xem!</p>
                    <a href="index.html" class="px-6 py-3 bg-primary text-black font-bold rounded-lg hover:bg-primary/90 transition-colors inline-block">
                        V·ªÅ trang ch·ªß
                    </a>
                </div>
            `;
        } else {
            console.log('Video URL:', videoUrl);
            loadMovieInfo(slug);
            initPlayer(videoUrl);
        }

        // Load movie info from API
        async function loadMovieInfo(slug) {
            try {
                const response = await fetch(`https://ophim1.com/phim/${slug}`);
                const data = await response.json();

                if (data && data.movie) {
                    const movie = data.movie;
                    document.getElementById('movieTitle').textContent = movie.name;
                    document.getElementById('movieDetails').innerHTML = `
                        <div class="flex flex-wrap gap-4 text-sm">
                            <span>${movie.origin_name || ''}</span>
                            <span>‚Ä¢</span>
                            <span>${movie.year || 'N/A'}</span>
                            <span>‚Ä¢</span>
                            <span>${movie.quality || 'HD'}</span>
                            <span>‚Ä¢</span>
                            <span>${movie.time || 'N/A'}</span>
                        </div>
                    `;
                    document.title = `${movie.name} - CineStream`;
                }
            } catch (error) {
                console.error('Error loading movie info:', error);
            }
        }

        // Initialize video player
        function initPlayer(videoUrl) {
            const container = document.getElementById('playerContainer');
            const loading = document.getElementById('loading');

            // Use proxy to bypass CORS
            const proxyUrl = `http://localhost:3001/proxy?url=${encodeURIComponent(videoUrl)}`;
            console.log('Using proxy URL:', proxyUrl);

            // Create video element
            const video = document.createElement('video');
            video.id = 'videoPlayer';
            video.className = 'w-full h-full';
            video.controls = true;
            video.autoplay = true;
            video.controlsList = 'nodownload';

            container.appendChild(video);

            // Initialize HLS.js
            if (Hls.isSupported()) {
                console.log('‚úÖ HLS.js is supported');
                const hls = new Hls({
                    debug: true,
                    enableWorker: true,
                    lowLatencyMode: true,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 600,
                    xhrSetup: function (xhr, url) {
                        // Add custom headers if needed
                        xhr.setRequestHeader('Origin', window.location.origin);
                    }
                });

                hls.loadSource(proxyUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    console.log('‚úÖ Video ready to play');
                    loading.style.display = 'none';
                    video.play().catch(e => {
                        console.log('Autoplay prevented:', e);
                        loading.innerHTML = `
                            <div class="text-center">
                                <span class="material-icons-round text-6xl text-primary mb-4">play_circle</span>
                                <p class="text-white text-lg mb-4">Nh·∫•n n√∫t play ƒë·ªÉ xem phim</p>
                            </div>
                        `;
                    });
                });

                hls.on(Hls.Events.ERROR, function (event, data) {
                    console.error('‚ùå HLS Error:', data);
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log('üîÑ Network error, trying to recover...');
                                setTimeout(() => {
                                    hls.startLoad();
                                }, 1000);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('üîÑ Media error, trying to recover...');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.error('üí• Fatal error, cannot recover');
                                loading.innerHTML = `
                                    <div class="text-center">
                                        <span class="material-icons-round text-6xl text-red-400 mb-4">error_outline</span>
                                        <p class="text-red-400 text-lg mb-2">Kh√¥ng th·ªÉ ph√°t video</p>
                                        <p class="text-gray-400 text-sm mb-4">Vui l√≤ng ki·ªÉm tra:</p>
                                        <ul class="text-gray-400 text-sm mb-4 text-left max-w-md mx-auto">
                                            <li>‚Ä¢ Proxy server ƒëang ch·∫°y (npm run proxy)</li>
                                            <li>‚Ä¢ Link video c√≤n h·ª£p l·ªá</li>
                                            <li>‚Ä¢ K·∫øt n·ªëi internet ·ªïn ƒë·ªãnh</li>
                                        </ul>
                                        <button onclick="location.reload()" class="px-6 py-3 bg-primary text-black font-bold rounded-lg hover:bg-primary/90 transition-colors">
                                            Th·ª≠ l·∫°i
                                        </button>
                                    </div>
                                `;
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                console.log('‚úÖ Using native HLS support (Safari)');
                video.src = proxyUrl;
                video.addEventListener('loadedmetadata', () => {
                    console.log('‚úÖ Video metadata loaded');
                    loading.style.display = 'none';
                });
                video.addEventListener('error', (e) => {
                    console.error('‚ùå Video error:', e);
                    loading.innerHTML = `
                        <div class="text-center">
                            <span class="material-icons-round text-6xl text-red-400 mb-4">error_outline</span>
                            <p class="text-red-400 text-lg">Kh√¥ng th·ªÉ ph√°t video</p>
                        </div>
                    `;
                });
            } else {
                console.error('‚ùå HLS not supported');
                loading.innerHTML = `
                    <div class="text-center">
                        <span class="material-icons-round text-6xl text-red-400 mb-4">error_outline</span>
                        <p class="text-red-400 text-lg">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t video HLS</p>
                        <p class="text-gray-400 text-sm mt-2">Vui l√≤ng s·ª≠ d·ª•ng Chrome, Firefox ho·∫∑c Safari</p>
                    </div>
                `;
            }
        }
    </script>
</body>

</html>