<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Proxy Video</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>

<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Test Video Proxy</h1>

        <div class="mb-6">
            <label class="block mb-2">Nh·∫≠p link m3u8:</label>
            <input type="text" id="videoUrl"
                class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded text-white"
                placeholder="https://vip.opstream90.com/share/...">
            <button onclick="loadVideo()" class="mt-2 px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold">
                Load Video
            </button>
        </div>

        <div class="aspect-video bg-black rounded-lg overflow-hidden mb-4">
            <video id="video" class="w-full h-full" controls></video>
        </div>

        <div id="log" class="bg-gray-800 p-4 rounded text-sm font-mono max-h-64 overflow-y-auto"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function loadVideo() {
            const videoUrl = document.getElementById('videoUrl').value.trim();
            if (!videoUrl) {
                alert('Vui l√≤ng nh·∫≠p link video!');
                return;
            }

            log('üé¨ Loading video: ' + videoUrl);

            const proxyUrl = `http://localhost:3001/proxy?url=${encodeURIComponent(videoUrl)}`;
            log('üì° Proxy URL: ' + proxyUrl);

            const video = document.getElementById('video');

            if (Hls.isSupported()) {
                log('‚úÖ HLS.js is supported');

                const hls = new Hls({
                    debug: true,
                    enableWorker: true,
                });

                hls.loadSource(proxyUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    log('‚úÖ Manifest parsed - Video ready!');
                    video.play();
                });

                hls.on(Hls.Events.ERROR, function (event, data) {
                    log('‚ùå Error: ' + data.type + ' - ' + data.details);
                    if (data.fatal) {
                        log('üí• Fatal error!');
                    }
                });

                hls.on(Hls.Events.FRAG_LOADED, function () {
                    log('üì¶ Fragment loaded');
                });
            } else {
                log('‚ùå HLS.js not supported');
            }
        }

        // Auto-load from localStorage if available
        window.onload = function () {
            const movieLinks = JSON.parse(localStorage.getItem('movieLinks') || '{}');
            const firstLink = Object.values(movieLinks)[0];
            if (firstLink) {
                document.getElementById('videoUrl').value = firstLink;
                log('üìã Loaded link from localStorage');
            }
        };
    </script>
</body>

</html>